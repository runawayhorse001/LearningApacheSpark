

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>16. ALS: Stock Portfolio Recommendations &mdash; Learning Apache Spark with Python  documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/icon.ico"/>
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/fix_rtd.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="17. Monte Carlo Simulation" href="mc.html" />
    <link rel="prev" title="15. Social Network Analysis" href="socialnetwork.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Learning Apache Spark with Python
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preface.html">1. Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="why.html">2. Why Spark with Python ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">3. Configure Running Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">4. An Introduction to Apache Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="rdd.html">5. Programming with RDDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="stats.html">6. Statistics and Linear Algebra Preliminaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="exploration.html">7. Data Exploration</a></li>
<li class="toctree-l1"><a class="reference internal" href="manipulation.html">8. Data Manipulation: Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression.html">9. Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="reg.html">10. Regularization</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification.html">11. Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="clustering.html">12. Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="rfm.html">13. RFM Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="textmining.html">14. Text Mining</a></li>
<li class="toctree-l1"><a class="reference internal" href="socialnetwork.html">15. Social Network Analysis</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">16. ALS: Stock Portfolio Recommendations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#recommender-systems">16.1. Recommender systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="#alternating-least-squares">16.2. Alternating Least Squares</a></li>
<li class="toctree-l2"><a class="reference internal" href="#demo">16.3. Demo</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#load-and-clean-data">16.3.1. Load and clean data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-feature-matrix">16.3.2. Build feature matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="#train-model">16.3.3. Train model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#make-prediction">16.3.4. Make prediction</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mc.html">17. Monte Carlo Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="mcmc.html">18. Markov Chain Monte Carlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="fnn.html">19. Neural Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto.html">20. Automation for Cloudera Distribution Hadoop</a></li>
<li class="toctree-l1"><a class="reference internal" href="pack.html">21. Wrap PySpark Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="audit.html">22. PySpark Data Audit Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="ze2nb.html">23. Zeppelin to jupyter notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="cheat.html">24. My Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="jdbc.html">25. JDBC Connection</a></li>
<li class="toctree-l1"><a class="reference internal" href="bricks.html">26. Databricks Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">27. PySpark API</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">28. Main Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Learning Apache Spark with Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li><span class="section-number">16. </span>ALS: Stock Portfolio Recommendations</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="als-stock-portfolio-recommendations">
<span id="als"></span><h1><span class="section-number">16. </span>ALS: Stock Portfolio Recommendations<a class="headerlink" href="#als-stock-portfolio-recommendations" title="Permalink to this headline">¶</a></h1>
<div class="admonition-chinese-proverb admonition">
<p class="admonition-title">Chinese proverb</p>
<p><strong>Don’t put all your eggs in one basket.</strong></p>
</div>
<div class="figure align-center">
<img alt="_images/stock_portfolio.png" src="_images/stock_portfolio.png" />
</div>
<p>Code for the above figure:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">))</span>

<span class="n">recipe</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;375 k U.S. Large Cap Blend&quot;</span><span class="p">,</span>
          <span class="s2">&quot;300 k U.S. Large Cap Value&quot;</span><span class="p">,</span>
          <span class="s2">&quot;75 k U.S. Short-Term Bonds&quot;</span><span class="p">,</span>
          <span class="s2">&quot;50 k U.S. Small Cap Blend&quot;</span><span class="p">,</span>
          <span class="s2">&quot;55 k U.S. Small Cap Value&quot;</span><span class="p">,</span>
          <span class="s2">&quot;95 k U.S. Real Estate&quot;</span><span class="p">,</span>
          <span class="s2">&quot;250 k Intermediate-Term Bonds&quot;</span><span class="p">]</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">recipe</span><span class="p">]</span>
<span class="n">ingredients</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">recipe</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ingredients</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span> <span class="n">allvals</span><span class="p">):</span>
    <span class="n">absolute</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pct</span><span class="o">/</span><span class="mf">100.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">allvals</span><span class="p">))</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">(</span><span class="si">{:d}</span><span class="s2"> k)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span> <span class="n">absolute</span><span class="p">)</span>

<span class="n">explode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="c1">#(0.1, 0.1, 0.1,  0.1, 0.1, 0.1)  # explode 1st slice</span>
<span class="n">explode</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">wedges</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">autotexts</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">explode</span><span class="o">=</span><span class="n">explode</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pct</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">pct</span><span class="p">,</span> <span class="n">data</span><span class="p">),</span>
                                  <span class="n">textprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">wedges</span><span class="p">,</span> <span class="n">ingredients</span><span class="p">,</span>
          <span class="c1">#title=&quot;Stock portfolio&quot;,</span>
          <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center left&quot;</span><span class="p">,</span>
          <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">autotexts</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

<span class="c1">#ax.set_title(&quot;Stock portfolio&quot;)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="recommender-systems">
<h2><span class="section-number">16.1. </span>Recommender systems<a class="headerlink" href="#recommender-systems" title="Permalink to this headline">¶</a></h2>
<p>Recommender systems or recommendation systems (sometimes replacing “system” with a synonym such as platform or engine) are a subclass of information filtering system that seek to predict the “rating” or “preference” that a user would give to an item.”</p>
<p>The main idea is to build a matrix users <code class="docutils literal notranslate"><span class="pre">R</span></code> items rating values and try to factorize it, to recommend main products rated by other users. A popular approach for this is matrix factorization is Alternating Least Squares (ALS)</p>
</div>
<div class="section" id="alternating-least-squares">
<h2><span class="section-number">16.2. </span>Alternating Least Squares<a class="headerlink" href="#alternating-least-squares" title="Permalink to this headline">¶</a></h2>
<p>Apache Spark ML implements ALS for collaborative filtering, a very popular algorithm for making recommendations.</p>
<p>ALS recommender is a matrix factorization algorithm that uses Alternating Least Squares with Weighted-Lamda-Regularization (ALS-WR). It factors the user to item matrix <code class="docutils literal notranslate"><span class="pre">A</span></code> into the user-to-feature matrix <code class="docutils literal notranslate"><span class="pre">U</span></code> and the item-to-feature matrix <code class="docutils literal notranslate"><span class="pre">M</span></code>: It runs the ALS algorithm in a parallel fashion.  The ALS algorithm should uncover the latent factors that explain the observed user to item ratings and tries to find optimal factor weights to minimize the least squares between predicted and actual ratings.</p>
<p><a class="reference external" href="https://www.elenacuoco.com/2016/12/22/alternating-least-squares-als-spark-ml/">https://www.elenacuoco.com/2016/12/22/alternating-least-squares-als-spark-ml/</a></p>
</div>
<div class="section" id="demo">
<h2><span class="section-number">16.3. </span>Demo<a class="headerlink" href="#demo" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The Jupyter notebook can be download from <a class="reference external" href="_static/ALS.ipynb">ALS Recommender systems</a>.</p></li>
<li><p>The data can be downloaf from <a class="reference external" href="_static/OnlineRetail.csv">German Credit</a>.</p></li>
</ul>
<div class="section" id="load-and-clean-data">
<h3><span class="section-number">16.3.1. </span>Load and clean data<a class="headerlink" href="#load-and-clean-data" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Set up spark context and SparkSession</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span> \
    <span class="o">.</span><span class="n">builder</span> \
    <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;Python Spark RFM example&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">&quot;spark.some.config.option&quot;</span><span class="p">,</span> <span class="s2">&quot;some-value&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Load dataset</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_raw</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;com.databricks.spark.csv&#39;</span><span class="p">)</span><span class="o">.</span>\
                       <span class="n">options</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> \
                       <span class="n">inferschema</span><span class="o">=</span><span class="s1">&#39;true&#39;</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">load</span><span class="p">(</span><span class="s2">&quot;Online Retail.csv&quot;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
<p>check the data set</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_raw</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">df_raw</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>
</div>
<p>Then you will get</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+---------+---------+--------------------+--------+------------+---------+----------+--------------+</span>
<span class="o">|</span><span class="n">InvoiceNo</span><span class="o">|</span><span class="n">StockCode</span><span class="o">|</span>         <span class="n">Description</span><span class="o">|</span><span class="n">Quantity</span><span class="o">|</span> <span class="n">InvoiceDate</span><span class="o">|</span><span class="n">UnitPrice</span><span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span>       <span class="n">Country</span><span class="o">|</span>
<span class="o">+---------+---------+--------------------+--------+------------+---------+----------+--------------+</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>   <span class="mi">85123</span><span class="n">A</span><span class="o">|</span><span class="n">WHITE</span> <span class="n">HANGING</span> <span class="n">HEA</span><span class="o">...|</span>       <span class="mi">6</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">2.55</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>    <span class="mi">71053</span><span class="o">|</span> <span class="n">WHITE</span> <span class="n">METAL</span> <span class="n">LANTERN</span><span class="o">|</span>       <span class="mi">6</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">3.39</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>   <span class="mi">84406</span><span class="n">B</span><span class="o">|</span><span class="n">CREAM</span> <span class="n">CUPID</span> <span class="n">HEART</span><span class="o">...|</span>       <span class="mi">8</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">2.75</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>   <span class="mi">84029</span><span class="n">G</span><span class="o">|</span><span class="n">KNITTED</span> <span class="n">UNION</span> <span class="n">FLA</span><span class="o">...|</span>       <span class="mi">6</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">3.39</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span>
<span class="o">|</span>   <span class="mi">536365</span><span class="o">|</span>   <span class="mi">84029</span><span class="n">E</span><span class="o">|</span><span class="n">RED</span> <span class="n">WOOLLY</span> <span class="n">HOTTIE</span><span class="o">...|</span>       <span class="mi">6</span><span class="o">|</span><span class="mi">12</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span> <span class="mi">8</span><span class="p">:</span><span class="mi">26</span><span class="o">|</span>     <span class="mf">3.39</span><span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="n">United</span> <span class="n">Kingdom</span><span class="o">|</span>
<span class="o">+---------+---------+--------------------+--------+------------+---------+----------+--------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>

<span class="n">root</span>
 <span class="o">|--</span> <span class="n">InvoiceNo</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">StockCode</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">Description</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">Quantity</span><span class="p">:</span> <span class="n">integer</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">InvoiceDate</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">UnitPrice</span><span class="p">:</span> <span class="n">double</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">CustomerID</span><span class="p">:</span> <span class="n">integer</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">Country</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Data clean and data manipulation</p></li>
</ol>
<ul class="simple">
<li><p>check and remove the <code class="docutils literal notranslate"><span class="pre">null</span></code> values</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">count</span>

<span class="k">def</span> <span class="nf">my_count</span><span class="p">(</span><span class="n">df_in</span><span class="p">):</span>
    <span class="n">df_in</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span> <span class="o">*</span><span class="p">[</span> <span class="n">count</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_in</span><span class="o">.</span><span class="n">columns</span> <span class="p">]</span> <span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="nb">round</span>
<span class="n">df_raw</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;Asset&#39;</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;Quantity&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;UnitPrice&#39;</span><span class="p">),</span> <span class="mi">2</span> <span class="p">))</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;StockCode&#39;</span><span class="p">,</span> <span class="s1">&#39;Cusip&#39;</span><span class="p">)</span>\
           <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">,</span><span class="s1">&#39;Cusip&#39;</span><span class="p">,</span><span class="s1">&#39;Quantity&#39;</span><span class="p">,</span><span class="s1">&#39;UnitPrice&#39;</span><span class="p">,</span><span class="s1">&#39;Asset&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_count</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+------+--------+---------+------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span> <span class="n">Cusip</span><span class="o">|</span><span class="n">Quantity</span><span class="o">|</span><span class="n">UnitPrice</span><span class="o">|</span> <span class="n">Asset</span><span class="o">|</span>
<span class="o">+----------+------+--------+---------+------+</span>
<span class="o">|</span>    <span class="mi">406829</span><span class="o">|</span><span class="mi">541909</span><span class="o">|</span>  <span class="mi">541909</span><span class="o">|</span>   <span class="mi">541909</span><span class="o">|</span><span class="mi">541909</span><span class="o">|</span>
<span class="o">+----------+------+--------+---------+------+</span>
</pre></div>
</div>
<p>Since the count results are not the same, we have some null value in the <code class="docutils literal notranslate"><span class="pre">CustomerID</span></code> column. We can drop these records from the dataset.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span>  <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;Asset&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">)</span>
<span class="n">my_count</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+------+--------+---------+------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span> <span class="n">Cusip</span><span class="o">|</span><span class="n">Quantity</span><span class="o">|</span><span class="n">UnitPrice</span><span class="o">|</span> <span class="n">Asset</span><span class="o">|</span>
<span class="o">+----------+------+--------+---------+------+</span>
<span class="o">|</span>    <span class="mi">397924</span><span class="o">|</span><span class="mi">397924</span><span class="o">|</span>  <span class="mi">397924</span><span class="o">|</span>   <span class="mi">397924</span><span class="o">|</span><span class="mi">397924</span><span class="o">|</span>
<span class="o">+----------+------+--------+---------+------+</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="o">+----------+------+--------+---------+-----+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span> <span class="n">Cusip</span><span class="o">|</span><span class="n">Quantity</span><span class="o">|</span><span class="n">UnitPrice</span><span class="o">|</span><span class="n">Asset</span><span class="o">|</span>
<span class="o">+----------+------+--------+---------+-----+</span>
<span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="mi">85123</span><span class="n">A</span><span class="o">|</span>       <span class="mi">6</span><span class="o">|</span>     <span class="mf">2.55</span><span class="o">|</span> <span class="mf">15.3</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span> <span class="mi">71053</span><span class="o">|</span>       <span class="mi">6</span><span class="o">|</span>     <span class="mf">3.39</span><span class="o">|</span><span class="mf">20.34</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">17850</span><span class="o">|</span><span class="mi">84406</span><span class="n">B</span><span class="o">|</span>       <span class="mi">8</span><span class="o">|</span>     <span class="mf">2.75</span><span class="o">|</span> <span class="mf">22.0</span><span class="o">|</span>
<span class="o">+----------+------+--------+---------+-----+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">3</span> <span class="n">rows</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Convert the <code class="docutils literal notranslate"><span class="pre">Cusip</span></code> to consistent format</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">DoubleType</span>

<span class="k">def</span> <span class="nf">toUpper</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

<span class="n">upper_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">toUpper</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">StringType</span><span class="p">())</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Find the most top <code class="docutils literal notranslate"><span class="pre">n</span></code> stockes</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pop</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;Cusip&#39;</span><span class="p">)</span>\
  <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;Customers&#39;</span><span class="p">),</span><span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;Asset&#39;</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;TotalAsset&#39;</span><span class="p">))</span>\
  <span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;Customers&#39;</span><span class="p">),</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;TotalAsset&#39;</span><span class="p">)],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="n">pop</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+------+---------+----------+</span>
<span class="o">|</span> <span class="n">Cusip</span><span class="o">|</span><span class="n">Customers</span><span class="o">|</span><span class="n">TotalAsset</span><span class="o">|</span>
<span class="o">+------+---------+----------+</span>
<span class="o">|</span><span class="mi">85123</span><span class="n">A</span><span class="o">|</span>     <span class="mi">2035</span><span class="o">|</span>  <span class="mf">100603.5</span><span class="o">|</span>
<span class="o">|</span> <span class="mi">22423</span><span class="o">|</span>     <span class="mi">1724</span><span class="o">|</span> <span class="mf">142592.95</span><span class="o">|</span>
<span class="o">|</span><span class="mi">85099</span><span class="n">B</span><span class="o">|</span>     <span class="mi">1618</span><span class="o">|</span>  <span class="mf">85220.78</span><span class="o">|</span>
<span class="o">|</span> <span class="mi">84879</span><span class="o">|</span>     <span class="mi">1408</span><span class="o">|</span>  <span class="mf">56580.34</span><span class="o">|</span>
<span class="o">|</span> <span class="mi">47566</span><span class="o">|</span>     <span class="mi">1397</span><span class="o">|</span>  <span class="mf">68844.33</span><span class="o">|</span>
<span class="o">+------+---------+----------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
</div>
<div class="section" id="build-feature-matrix">
<h3><span class="section-number">16.3.2. </span>Build feature matrix<a class="headerlink" href="#build-feature-matrix" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Fetch the top <code class="docutils literal notranslate"><span class="pre">n</span></code> cusip list</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">top</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">cusip_lst</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pop</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;Cusip&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">cusip_lst</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Create the portfolio table for each customer</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pivot_tab</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;Cusip&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;Asset&#39;</span><span class="p">)</span>
<span class="n">pivot_tab</span> <span class="o">=</span> <span class="n">pivot_tab</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Fetch the most <code class="docutils literal notranslate"><span class="pre">n</span></code> stock’s portfolio table for each customer</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">selected_tab</span>  <span class="o">=</span> <span class="n">pivot_tab</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">cusip_lst</span><span class="p">)</span>
<span class="n">selected_tab</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+------+-----+------+-----+-----+-----+-----+-----+----+-----+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="mi">85123</span><span class="n">A</span><span class="o">|</span><span class="mi">22423</span><span class="o">|</span><span class="mi">85099</span><span class="n">B</span><span class="o">|</span><span class="mi">84879</span><span class="o">|</span><span class="mi">47566</span><span class="o">|</span><span class="mi">20725</span><span class="o">|</span><span class="mi">22720</span><span class="o">|</span><span class="mi">20727</span><span class="o">|</span><span class="n">POST</span><span class="o">|</span><span class="mi">23203</span><span class="o">|</span>
<span class="o">+----------+------+-----+------+-----+-----+-----+-----+-----+----+-----+</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span> <span class="mf">33.0</span><span class="o">|</span> <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">15727</span><span class="o">|</span> <span class="mf">123.9</span><span class="o">|</span> <span class="mf">25.5</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span> <span class="mf">33.0</span><span class="o">|</span> <span class="mf">99.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span> <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">14570</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span> <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">14450</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">8.32</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span> <span class="mf">49.5</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span> <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>
<span class="o">+----------+------+-----+------+-----+-----+-----+-----+-----+----+-----+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">4</span> <span class="n">rows</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Build the <code class="docutils literal notranslate"><span class="pre">rating</span></code> matrix</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">elemwiseDiv</span><span class="p">(</span><span class="n">df_in</span><span class="p">):</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_in</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">df_in</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">flatten</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                                                       <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                                       <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num</span><span class="p">)]])))</span>
    <span class="k">return</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">df_in</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="n">ratings</span> <span class="o">=</span> <span class="n">elemwiseDiv</span><span class="p">(</span><span class="n">selected_tab</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ratings</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="o">+----------+------+-----+------+-----+-----+-----+-----+-----+----+-----+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="mi">85123</span><span class="n">A</span><span class="o">|</span><span class="mi">22423</span><span class="o">|</span><span class="mi">85099</span><span class="n">B</span><span class="o">|</span><span class="mi">84879</span><span class="o">|</span><span class="mi">47566</span><span class="o">|</span><span class="mi">20725</span><span class="o">|</span><span class="mi">22720</span><span class="o">|</span><span class="mi">20727</span><span class="o">|</span><span class="n">POST</span><span class="o">|</span><span class="mi">23203</span><span class="o">|</span>
<span class="o">+----------+------+-----+------+-----+-----+-----+-----+-----+----+-----+</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">1.0</span><span class="o">|</span> <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">15727</span><span class="o">|</span>  <span class="mf">0.44</span><span class="o">|</span> <span class="mf">0.09</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span> <span class="mf">0.12</span><span class="o">|</span> <span class="mf">0.35</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span> <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">14570</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span> <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">14450</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.14</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span> <span class="mf">0.86</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span> <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.0</span><span class="o">|</span>
<span class="o">+----------+------+-----+------+-----+-----+-----+-----+-----+----+-----+</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Convert <code class="docutils literal notranslate"><span class="pre">rating</span></code> matrix to long table</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">array</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">explode</span><span class="p">,</span> <span class="n">struct</span><span class="p">,</span> <span class="n">lit</span>

<span class="k">def</span> <span class="nf">to_long</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">by</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        reference: https://stackoverflow.com/questions/37864222/transpose-column-to-row-with-spark</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="c1"># Filter dtypes and split into column names and type description</span>
    <span class="n">cols</span><span class="p">,</span> <span class="n">dtypes</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">by</span><span class="p">))</span>
    <span class="c1"># Spark SQL supports only homogeneous columns</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dtypes</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;All columns have to be of the same type&quot;</span>

    <span class="c1"># Create and explode an array of (column_name, column_value) structs</span>
    <span class="n">kvs</span> <span class="o">=</span> <span class="n">explode</span><span class="p">(</span><span class="n">array</span><span class="p">([</span>
      <span class="n">struct</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Cusip&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span>
    <span class="p">]))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;kvs&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df_all</span> <span class="o">=</span> <span class="n">to_long</span><span class="p">(</span><span class="n">ratings</span><span class="p">,[</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">])</span>
<span class="n">df_all</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+------+------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span> <span class="n">Cusip</span><span class="o">|</span><span class="n">rating</span><span class="o">|</span>
<span class="o">+----------+------+------+</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span><span class="mi">85123</span><span class="n">A</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span> <span class="mi">22423</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span><span class="mi">85099</span><span class="n">B</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span> <span class="mi">84879</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span> <span class="mi">47566</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>
<span class="o">+----------+------+------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Convert the string <code class="docutils literal notranslate"><span class="pre">Cusip</span></code> to numerical index</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">StringIndexer</span>
<span class="c1"># Index labels, adding metadata to the label column</span>
<span class="n">labelIndexer</span> <span class="o">=</span> <span class="n">StringIndexer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">&#39;Cusip&#39;</span><span class="p">,</span>
                             <span class="n">outputCol</span><span class="o">=</span><span class="s1">&#39;indexedCusip&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_all</span><span class="p">)</span>
<span class="n">df_all</span> <span class="o">=</span> <span class="n">labelIndexer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df_all</span><span class="p">)</span>

<span class="n">df_all</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">df_all</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+------+------+------------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span> <span class="n">Cusip</span><span class="o">|</span><span class="n">rating</span><span class="o">|</span><span class="n">indexedCusip</span><span class="o">|</span>
<span class="o">+----------+------+------+------------+</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span><span class="mi">85123</span><span class="n">A</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>         <span class="mf">6.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span> <span class="mi">22423</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>         <span class="mf">9.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span><span class="mi">85099</span><span class="n">B</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>         <span class="mf">5.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span> <span class="mi">84879</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>         <span class="mf">1.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">16503</span><span class="o">|</span> <span class="mi">47566</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>         <span class="mf">0.0</span><span class="o">|</span>
<span class="o">+----------+------+------+------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>

<span class="n">root</span>
 <span class="o">|--</span> <span class="n">CustomerID</span><span class="p">:</span> <span class="n">long</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">Cusip</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">false</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">rating</span><span class="p">:</span> <span class="n">double</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|--</span> <span class="n">indexedCusip</span><span class="p">:</span> <span class="n">double</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="train-model">
<h3><span class="section-number">16.3.3. </span>Train model<a class="headerlink" href="#train-model" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>build <code class="docutils literal notranslate"><span class="pre">train</span></code> and <code class="docutils literal notranslate"><span class="pre">test</span></code> dataset</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.2</span><span class="p">])</span>

<span class="n">train</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+-----+------------+-------------------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="n">Cusip</span><span class="o">|</span><span class="n">indexedCusip</span><span class="o">|</span>             <span class="n">rating</span><span class="o">|</span>
<span class="o">+----------+-----+------------+-------------------+</span>
<span class="o">|</span>     <span class="mi">12940</span><span class="o">|</span><span class="mi">20725</span><span class="o">|</span>         <span class="mf">2.0</span><span class="o">|</span>                <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">12940</span><span class="o">|</span><span class="mi">20727</span><span class="o">|</span>         <span class="mf">4.0</span><span class="o">|</span>                <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">12940</span><span class="o">|</span><span class="mi">22423</span><span class="o">|</span>         <span class="mf">9.0</span><span class="o">|</span><span class="mf">0.49990198000392083</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">12940</span><span class="o">|</span><span class="mi">22720</span><span class="o">|</span>         <span class="mf">3.0</span><span class="o">|</span>                <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">12940</span><span class="o">|</span><span class="mi">23203</span><span class="o">|</span>         <span class="mf">7.0</span><span class="o">|</span>                <span class="mf">0.0</span><span class="o">|</span>
<span class="o">+----------+-----+------------+-------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>

<span class="o">+----------+-----+------------+------------------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span><span class="n">Cusip</span><span class="o">|</span><span class="n">indexedCusip</span><span class="o">|</span>            <span class="n">rating</span><span class="o">|</span>
<span class="o">+----------+-----+------------+------------------+</span>
<span class="o">|</span>     <span class="mi">12940</span><span class="o">|</span><span class="mi">84879</span><span class="o">|</span>         <span class="mf">1.0</span><span class="o">|</span><span class="mf">0.1325230346990786</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">13285</span><span class="o">|</span><span class="mi">20725</span><span class="o">|</span>         <span class="mf">2.0</span><span class="o">|</span><span class="mf">0.2054154995331466</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">13285</span><span class="o">|</span><span class="mi">20727</span><span class="o">|</span>         <span class="mf">4.0</span><span class="o">|</span><span class="mf">0.2054154995331466</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">13285</span><span class="o">|</span><span class="mi">47566</span><span class="o">|</span>         <span class="mf">0.0</span><span class="o">|</span>               <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">13623</span><span class="o">|</span><span class="mi">23203</span><span class="o">|</span>         <span class="mf">7.0</span><span class="o">|</span>               <span class="mf">0.0</span><span class="o">|</span>
<span class="o">+----------+-----+------------+------------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
<ul class="simple">
<li><p>train model</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">add</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.recommendation</span> <span class="kn">import</span> <span class="n">ALS</span>

<span class="kn">from</span> <span class="nn">pyspark.ml.evaluation</span> <span class="kn">import</span> <span class="n">RegressionEvaluator</span>

<span class="n">evaluator</span> <span class="o">=</span> <span class="n">RegressionEvaluator</span><span class="p">(</span><span class="n">metricName</span><span class="o">=</span><span class="s2">&quot;rmse&quot;</span><span class="p">,</span> <span class="n">labelCol</span><span class="o">=</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span>
                                <span class="n">predictionCol</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">computeRmse</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute RMSE (Root mean Squared Error).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Root-mean-square error = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rmse</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">rmse</span>

<span class="c1">#train models and evaluate them on the validation set</span>

<span class="n">ranks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="n">lambdas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">]</span>
<span class="n">numIters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">]</span>
<span class="n">bestModel</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">bestValidationRmse</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
<span class="n">bestRank</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">bestLambda</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="n">bestNumIter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="n">val</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
<span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">,</span> <span class="n">numIter</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">numIters</span><span class="p">):</span>
    <span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="n">maxIter</span><span class="o">=</span><span class="n">numIter</span><span class="p">,</span> <span class="n">regParam</span><span class="o">=</span><span class="n">lmbda</span><span class="p">,</span> <span class="n">numUserBlocks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">numItemBlocks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">implicitPrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">userCol</span><span class="o">=</span><span class="s2">&quot;CustomerID&quot;</span><span class="p">,</span> <span class="n">itemCol</span><span class="o">=</span><span class="s2">&quot;indexedCusip&quot;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ratingCol</span><span class="o">=</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="n">nonnegative</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span><span class="o">=</span><span class="n">als</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>

    <span class="n">validationRmse</span> <span class="o">=</span> <span class="n">computeRmse</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RMSE (validation) = </span><span class="si">%f</span><span class="s2"> for the model trained with &quot;</span> <span class="o">%</span> <span class="n">validationRmse</span> <span class="o">+</span> \
            <span class="s2">&quot;rank = </span><span class="si">%d</span><span class="s2">, lambda = </span><span class="si">%.1f</span><span class="s2">, and numIter = </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">,</span> <span class="n">numIter</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">validationRmse</span><span class="p">,</span> <span class="n">bestValidationRmse</span><span class="p">):</span>
        <span class="n">bestModel</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">bestValidationRmse</span> <span class="o">=</span> <span class="n">validationRmse</span>
        <span class="n">bestRank</span> <span class="o">=</span> <span class="n">rank</span>
        <span class="n">bestLambda</span> <span class="o">=</span> <span class="n">lmbda</span>
        <span class="n">bestNumIter</span> <span class="o">=</span> <span class="n">numIter</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">bestModel</span>
</pre></div>
</div>
</div>
<div class="section" id="make-prediction">
<h3><span class="section-number">16.3.4. </span>Make prediction<a class="headerlink" href="#make-prediction" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>make prediction</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">topredict</span><span class="o">=</span><span class="n">test</span><span class="p">[</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>

<span class="n">predictions</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">topredict</span><span class="p">)</span>
<span class="n">predictions</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">prediction</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>\
           <span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;CustomerID&#39;</span><span class="p">),</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;Cusip&#39;</span><span class="p">)],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">+----------+------+------------+------+------------+</span>
<span class="o">|</span><span class="n">CustomerID</span><span class="o">|</span> <span class="n">Cusip</span><span class="o">|</span><span class="n">indexedCusip</span><span class="o">|</span><span class="n">rating</span><span class="o">|</span>  <span class="n">prediction</span><span class="o">|</span>
<span class="o">+----------+------+------------+------+------------+</span>
<span class="o">|</span>     <span class="mi">18283</span><span class="o">|</span> <span class="mi">47566</span><span class="o">|</span>         <span class="mf">0.0</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span>  <span class="mf">0.01625076</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">18282</span><span class="o">|</span><span class="mi">85123</span><span class="n">A</span><span class="o">|</span>         <span class="mf">6.0</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span> <span class="mf">0.057172246</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">18282</span><span class="o">|</span> <span class="mi">84879</span><span class="o">|</span>         <span class="mf">1.0</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span> <span class="mf">0.059531752</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">18282</span><span class="o">|</span> <span class="mi">23203</span><span class="o">|</span>         <span class="mf">7.0</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span> <span class="mf">0.010502596</span><span class="o">|</span>
<span class="o">|</span>     <span class="mi">18282</span><span class="o">|</span> <span class="mi">22720</span><span class="o">|</span>         <span class="mf">3.0</span><span class="o">|</span>   <span class="mf">0.0</span><span class="o">|</span> <span class="mf">0.053893942</span><span class="o">|</span>
<span class="o">+----------+------+------------+------+------------+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="mc.html" class="btn btn-neutral float-right" title="17. Monte Carlo Simulation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="socialnetwork.html" class="btn btn-neutral float-left" title="15. Social Network Analysis" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Wenqiang Feng
      <span class="lastupdated">
        Last updated on Dec 27, 2021.
      </span>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>