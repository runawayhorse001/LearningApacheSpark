

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>26. Databricks Tips &mdash; Learning Apache Spark with Python  documentation</title>
  

  
  
    <link rel="shortcut icon" href="_static/icon.ico"/>
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/fix_rtd.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="27. PySpark API" href="api.html" />
    <link rel="prev" title="25. JDBC Connection" href="jdbc.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Learning Apache Spark with Python
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preface.html">1. Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="why.html">2. Why Spark with Python ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">3. Configure Running Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">4. An Introduction to Apache Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="rdd.html">5. Programming with RDDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="stats.html">6. Statistics and Linear Algebra Preliminaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="exploration.html">7. Data Exploration</a></li>
<li class="toctree-l1"><a class="reference internal" href="manipulation.html">8. Data Manipulation: Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="regression.html">9. Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="reg.html">10. Regularization</a></li>
<li class="toctree-l1"><a class="reference internal" href="classification.html">11. Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="clustering.html">12. Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="rfm.html">13. RFM Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="textmining.html">14. Text Mining</a></li>
<li class="toctree-l1"><a class="reference internal" href="socialnetwork.html">15. Social Network Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="als.html">16. ALS: Stock Portfolio Recommendations</a></li>
<li class="toctree-l1"><a class="reference internal" href="mc.html">17. Monte Carlo Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="mcmc.html">18. Markov Chain Monte Carlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="fnn.html">19. Neural Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="auto.html">20. Automation for Cloudera Distribution Hadoop</a></li>
<li class="toctree-l1"><a class="reference internal" href="pack.html">21. Wrap PySpark Package</a></li>
<li class="toctree-l1"><a class="reference internal" href="audit.html">22. PySpark Data Audit Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="ze2nb.html">23. Zeppelin to jupyter notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="cheat.html">24. My Cheat Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="jdbc.html">25. JDBC Connection</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">26. Databricks Tips</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#display-samples">26.1. Display samples</a></li>
<li class="toctree-l2"><a class="reference internal" href="#auto-files-download">26.2. Auto files download</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-aws-s3">26.3. Working with AWS S3</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#credentials">26.3.1. Credentials</a></li>
<li class="toctree-l3"><a class="reference internal" href="#file-upload-to-s3">26.3.2. File Upload to S3</a></li>
<li class="toctree-l3"><a class="reference internal" href="#file-download-from-s3">26.3.3. File Download from S3</a></li>
<li class="toctree-l3"><a class="reference internal" href="#file-management-in-s3">26.3.4. File Management in S3</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#delta-format">26.4. <code class="docutils literal notranslate"><span class="pre">delta</span></code> format</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mlflow">26.5. <code class="docutils literal notranslate"><span class="pre">mlflow</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">27. PySpark API</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">28. Main Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Learning Apache Spark with Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li><span class="section-number">26. </span>Databricks Tips</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="databricks-tips">
<span id="bricks"></span><h1><span class="section-number">26. </span>Databricks Tips<a class="headerlink" href="#databricks-tips" title="Permalink to this headline">¶</a></h1>
<p>In this chapter, I will share some of the useful tips when using Databricks.</p>
<div class="section" id="display-samples">
<h2><span class="section-number">26.1. </span>Display samples<a class="headerlink" href="#display-samples" title="Permalink to this headline">¶</a></h2>
<p>In pyspark, we can use <code class="docutils literal notranslate"><span class="pre">show()</span></code> to display the given size of the sample.
While in databricks environment, we also have <code class="docutils literal notranslate"><span class="pre">display()</span></code> function to
display the sample records. In general, the CPU time for big data table/set is</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="c1"># n is the number of the given size</span>
</pre></div>
</div>
</div>
<div class="section" id="auto-files-download">
<h2><span class="section-number">26.2. </span>Auto files download<a class="headerlink" href="#auto-files-download" title="Permalink to this headline">¶</a></h2>
<p>Databricks is the most powerful big data analytics and machine learning
platform, while it’s not perfect. The file management system is not that
good like jupyter Notebook/Lab. Here I will provide one way to download
the files under <code class="docutils literal notranslate"><span class="pre">dbfs:/FileStore</span></code> (This method only works for the files
under <code class="docutils literal notranslate"><span class="pre">dbfs:/FileStore</span></code>).</p>
<p>In general, the file link for downloading is like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cluster_address</span><span class="si">}</span><span class="s2">/files/</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">?o=</span><span class="si">{</span><span class="n">cluster_no</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>Here I provided my auto click download functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">IPython</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>

<span class="k">def</span> <span class="nf">get_hdfs_files</span><span class="p">(</span><span class="n">hdfs_path</span><span class="p">,</span> <span class="n">relative_path</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Get file names and file path or relative path for the given HDFS</span>
<span class="sd">path. Note: os.listdir does not work in ``community.cloud.databricks``.</span>

<span class="sd">:param hdfs_path: the input HDFS path</span>
<span class="sd">:param relative_path: flag of return full path or the path relative to</span>
<span class="sd">                      ``dbfs:/FileStore`` (We need the relative for the</span>
<span class="sd">                      file download.)</span>

<span class="sd">:return file_names: file names under the given path</span>
<span class="sd">:return  relative_p: file paths, full path if ``relative_path=False``</span>
<span class="sd">                     else paths relative to ``bdfs:/FileStore``</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># get the file information</span>
<span class="n">xx</span> <span class="o">=</span> <span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">hdfs_path</span><span class="p">)</span>

<span class="c1"># get hdfs path and folder name</span>
<span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">))]</span>
<span class="n">hdfs_paths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xx</span><span class="p">))]</span>

<span class="k">if</span> <span class="n">relative_path</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">relative_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">hdfs_path</span><span class="p">,</span> <span class="s1">&#39;dbfs:/FileStore&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">hdfs_path</span> <span class="ow">in</span> <span class="n">hdfs_paths</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only suooprt the files under &#39;dbfs:/FileStore/&#39;&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">relative_p</span> <span class="o">=</span> <span class="n">hdfs_paths</span>

<span class="k">return</span> <span class="n">file_names</span><span class="p">,</span> <span class="n">relative_p</span>


<span class="k">def</span> <span class="nf">azdb_files_download</span><span class="p">(</span><span class="n">files_path</span><span class="p">,</span> <span class="n">cluster_address</span><span class="o">=</span><span class="s2">&quot;https://community.cloud.databricks.com&quot;</span><span class="p">,</span>
                    <span class="n">cluster_no</span><span class="o">=</span><span class="s1">&#39;4622560542654492&#39;</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">List the files download links.</span>

<span class="sd">:param files_path: the given file path ot folder path</span>
<span class="sd">:param cluster_address: Your databricks cluster address, i.e. the link before ``/?o``</span>
<span class="sd">:param cluster_no: YOur databricks cluster number, i.e. the number after ``?o=``</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">files_path</span><span class="p">):</span>  <span class="c1"># os.path.isdir(files_path):</span>
    <span class="n">file_names</span><span class="p">,</span> <span class="n">files_path</span> <span class="o">=</span> <span class="n">get_hdfs_files</span><span class="p">(</span><span class="n">files_path</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">files_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">files_path</span><span class="p">]</span>

<span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cluster_address</span><span class="si">}</span><span class="s2">/files/</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">?o=</span><span class="si">{</span><span class="n">cluster_no</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">files_path</span><span class="p">]</span>

<span class="n">temp</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">       &lt;h2&gt;AZDB files download&lt;/h2&gt;</span>
<span class="s2">       {</span><span class="si">% f</span><span class="s2">or i in range(len(urls)) %}</span>

<span class="s2">          &lt;a href=&quot;{{urls[i]}}&quot; target=&#39;_blank&#39;&gt; Click me to download  {{files_path[i].split(&#39;/&#39;)[-1]}}&lt;/a&gt; &lt;br&gt;</span>
<span class="s2">       {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">       &quot;&quot;&quot;</span>

<span class="n">html</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">files_path</span><span class="o">=</span><span class="n">files_path</span><span class="p">,</span> <span class="n">urls</span><span class="o">=</span><span class="n">urls</span><span class="p">,</span> <span class="nb">len</span><span class="o">=</span><span class="nb">len</span><span class="p">)</span>

<span class="c1"># get dbutils module</span>
<span class="n">dbutils</span> <span class="o">=</span> <span class="n">IPython</span><span class="o">.</span><span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="s2">&quot;dbutils&quot;</span><span class="p">]</span>

<span class="n">dbutils</span><span class="o">.</span><span class="n">displayHTML</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In commercial version of databricks, you can use</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spark.databricks.clusterUsageTags.instanceWorkerEnvId&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>to get the <code class="docutils literal notranslate"><span class="pre">cluster_no</span></code>. But it will not work for community version.</p>
</div>
<p>By using the above code, you can download the files relative to <code class="docutils literal notranslate"><span class="pre">dbfs:/FileStore</span></code>.</p>
<p>The files under <code class="docutils literal notranslate"><span class="pre">dbfs:/FileStore/data</span></code></p>
<blockquote>
<div><div class="figure align-center" id="id1">
<span id="dbfs-data"></span><img alt="_images/dbfs_data.png" src="_images/dbfs_data.png" />
<p class="caption"><span class="caption-text">File under <code class="docutils literal notranslate"><span class="pre">dbfs:/FileStore/data</span></code></span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
</div></blockquote>
<p>Click download demos:</p>
<blockquote>
<div><div class="figure align-center" id="id2">
<span id="auto-download"></span><img alt="_images/auto_download.png" src="_images/auto_download.png" />
<p class="caption"><span class="caption-text">File download in databricks</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</div></blockquote>
</div>
<div class="section" id="working-with-aws-s3">
<h2><span class="section-number">26.3. </span>Working with AWS S3<a class="headerlink" href="#working-with-aws-s3" title="Permalink to this headline">¶</a></h2>
<p>Many companies chose to save sensitive data in AWS S3. So you may have to deal
with data with python in Databricks, while python will have many issues to
operate in Databricks(PySpark will not have problems if the environment was
set up correctly in Databricks): such as the <code class="docutils literal notranslate"><span class="pre">os.system</span></code> command-like
function can not use any more; no unified way to upload or download different
type files, etc. Here, I will provide my way to work in AWS S3 with python in
Databricks:</p>
<div class="section" id="credentials">
<h3><span class="section-number">26.3.1. </span>Credentials<a class="headerlink" href="#credentials" title="Permalink to this headline">¶</a></h3>
<p>I use Security Token Service (STS) to create the credentials to access AWS S3.
STS enables you to request temporary, limited-privilege credentials for
Identity and Access Management (IAM) users or for users that you
authenticate (federated users). More details can be found at:
<a class="reference external" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sts.html">https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sts.html</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">boto3</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;sts&#39;</span><span class="p">)</span>\
                <span class="o">.</span><span class="n">assume_role</span><span class="p">(</span><span class="n">RoleArn</span><span class="o">=</span><span class="s1">&#39;arn:aws:iam::123456789012:role/demo&#39;</span><span class="p">,</span>
                             <span class="n">RoleSessionName</span><span class="o">=</span><span class="s1">&#39;your_role_session_name&#39;</span><span class="p">)</span>
<span class="n">credentials</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Credentials&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="file-upload-to-s3">
<h3><span class="section-number">26.3.2. </span>File Upload to S3<a class="headerlink" href="#file-upload-to-s3" title="Permalink to this headline">¶</a></h3>
<p>The main idea at here is to save the file in memory or a temporary file, then
use <code class="docutils literal notranslate"><span class="pre">put_object</span></code> to put the file in S3. It’s a little bit tricky to save the
corresponding formatted file in memory, I will list several common types in the
examples.</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">s3_file_upload</span></code> Function</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">s3_file_upload</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>

    <span class="n">file_type</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="n">s3_content_type</span><span class="p">(</span><span class="n">file_type</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Do not support the current input type!!!&#39;</span><span class="p">)</span>

    <span class="n">s3_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;s3://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;s3a://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">s3_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">s3_resource</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>\
                   <span class="o">.</span><span class="n">put_object</span><span class="p">(</span><span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                               <span class="n">Body</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                               <span class="n">ContentType</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span>
                               <span class="n">ACL</span><span class="o">=</span><span class="s1">&#39;public-read&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> has been successfully saved in s3!&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p><code class="docutils literal notranslate"><span class="pre">s3_content_type</span></code> Function</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">s3_content_type</span><span class="p">(</span><span class="n">file_type</span><span class="p">):</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">png</span><span class="p">:</span><span class="n">image</span><span class="o">/</span><span class="n">png</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">file_type</span><span class="p">]</span>
</pre></div>
</div>
<p>The full mapping list can be found as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>3dm:x-world/x-3dmf
3dmf:x-world/x-3dmf
a:application/octet-stream
aab:application/x-authorware-bin
aam:application/x-authorware-map
aas:application/x-authorware-seg
abc:text/vnd.abc
acgi:text/html
afl:video/animaflex
ai:application/postscript
aif:audio/aiff
#aif:audio/x-aiff
aifc:audio/aiff
#aifc:audio/x-aiff
aiff:audio/aiff
#aiff:audio/x-aiff
aim:application/x-aim
aip:text/x-audiosoft-intra
ani:application/x-navi-animation
aos:application/x-nokia-9000-communicator-add-on-software
aps:application/mime
arc:application/octet-stream
arj:application/arj
art:image/x-jg
asf:video/x-ms-asf
asm:text/x-asm
asp:text/asp
asx:application/x-mplayer2
#asx:video/x-ms-asf
#asx:video/x-ms-asf-plugin
au:audio/basic
#au:audio/x-au
#avi:video/avi
#avi:video/msvideo
avi:video/x-msvideo
avs:video/avs-video
bcpio:application/x-bcpio
#bin:application/mac-binary
#bin:application/macbinary
#bin:application/octet-stream
bin:application/x-binary
#bin:application/x-macbinary
bm:image/bmp
bmp:image/bmp
boo:application/book
book:application/book
boz:application/x-bzip2
bsh:application/x-bsh
bz:application/x-bzip
bz2:application/x-bzip2
c:text/plain
c++:text/plain
cat:application/vnd.ms-pki.seccat
cc:text/plain
ccad:application/clariscad
cco:application/x-cocoa
cdf:application/cdf
cer:application/pkix-cert
cha:application/x-chat
chat:application/x-chat
class:application/java
com:application/octet-stream
conf:text/plain
cpio:application/x-cpio
cpp:text/x-c
cpt:application/mac-compactpro
crl:application/pkcs-crl
crt:application/pkix-cert
csh:application/x-csh
css:text/css
cxx:text/plain
dcr:application/x-director
deepv:application/x-deepv
def:text/plain
der:application/x-x509-ca-cert
dif:video/x-dv
dir:application/x-director
dl:video/dl
doc:application/msword
dot:application/msword
dp:application/commonground
drw:application/drafting
dump:application/octet-stream
dv:video/x-dv
dvi:application/x-dvi
dwf:model/vnd.dwf
dwg:application/acad
dxf:application/dxf
dxr:application/x-director
el:text/x-script.elisp
elc:application/x-bytecode.elisp
env:application/x-envoy
eps:application/postscript
es:application/x-esrehber
etx:text/x-setext
evy:application/envoy
exe:application/octet-stream
f:text/plain
f77:text/x-fortran
f90:text/plain
fdf:application/vnd.fdf
fif:application/fractals
fli:video/fli
flo:image/florian
flx:text/vnd.fmi.flexstor
fmf:video/x-atomic3d-feature
for:text/plain
fpx:image/vnd.fpx
frl:application/freeloader
funk:audio/make
g:text/plain
g3:image/g3fax
gif:image/gif
gl:video/gl
gsd:audio/x-gsm
gsm:audio/x-gsm
gsp:application/x-gsp
gss:application/x-gss
gtar:application/x-gtar
gz:application/x-gzip
gzip:application/x-gzip
h:text/plain
hdf:application/x-hdf
help:application/x-helpfile
hgl:application/vnd.hp-hpgl
hh:text/plain
hlp:application/hlp
hpg:application/vnd.hp-hpgl
hpgl:application/vnd.hp-hpgl
hqx:application/binhex
hta:application/hta
htc:text/x-component
htm:text/html
html:text/html
htmls:text/html
htt:text/webviewhtml
htx:text/html
ice:x-conference/x-cooltalk
ico:image/x-icon
idc:text/plain
ief:image/ief
iefs:image/ief
iges:application/iges
igs:application/iges
ima:application/x-ima
imap:application/x-httpd-imap
inf:application/inf
ins:application/x-internett-signup
ip:application/x-ip2
isu:video/x-isvideo
it:audio/it
iv:application/x-inventor
ivr:i-world/i-vrml
ivy:application/x-livescreen
jam:audio/x-jam
java:text/plain
jcm:application/x-java-commerce
jfif:image/jpeg
jpeg:image/jpeg
jpg:image/jpeg
jps:image/x-jps
js:application/x-javascript
jut:image/jutvision
kar:audio/midi
ksh:text/x-script.ksh
la:audio/nspaudio
lam:audio/x-liveaudio
latex:application/x-latex
lha:application/octet-stream
lhx:application/octet-stream
list:text/plain
lma:audio/nspaudio
log:text/plain
lst:text/plain
lsx:text/x-la-asf
ltx:application/x-latex
lzh:application/octet-stream
lzx:application/octet-stream
m:text/plain
m1v:video/mpeg
m2a:audio/mpeg
m2v:video/mpeg
m3u:audio/x-mpequrl
m4v:video/x-m4v
man:application/x-troff-man
mht:message/rfc822
mhtml:message/rfc822
midi:audio/midi
mif:application/x-frame
mjf:audio/x-vnd.audioexplosion.mjuicemediafile
mjpg:video/x-motion-jpeg
mod:audio/mod
mov:video/quicktime
movie:video/x-sgi-movie
mp2:audio/mpeg
mp3:audio/mpeg
#mpa:audio/mpeg
mpa:video/mpeg
mpc:application/x-project
mpeg:video/mpeg
mpg:video/mpeg
mpga:audio/mpeg
ogg:video/ogg
ogv:video/ogg
p:text/x-pascal
p10:application/pkcs10
#p12:application/pkcs-12
p12:application/x-pkcs12
p7a:application/x-pkcs7-signature
p7c:application/x-pkcs7-mime
p7m:application/pkcs7-mime
p7r:application/x-pkcs7-certreqresp
p7s:application/pkcs7-signature
part:application/pro_eng
pas:text/pascal
pbm:image/x-portable-bitmap
pcl:application/x-pcl
pct:image/x-pict
pcx:image/x-pcx
pdb:chemical/x-pdb
pdf:application/pdf
pfunk:audio/make
pgm:image/x-portable-graymap
pic:image/pict
pict:image/pict
pkg:application/x-newton-compatible-pkg
pko:application/vnd.ms-pki.pko
pl:text/plain
plx:application/x-pixclscript
pm:image/x-xpixmap
pm4:application/x-pagemaker
pm5:application/x-pagemaker
png:image/png
pnm:image/x-portable-anymap
pot:application/mspowerpoint
ppa:application/vnd.ms-powerpoint
ppm:image/x-portable-pixmap
pps:application/mspowerpoint
ppt:application/mspowerpoint
#ppt:application/powerpoint
#ppt:application/vnd.ms-powerpoint
#ppt:application/x-mspowerpoint
ppz:application/mspowerpoint
pre:application/x-freelance
prt:application/pro_eng
ps:application/postscript
psd:application/octet-stream
pvu:paleovu/x-pv
pwz:application/vnd.ms-powerpoint
py:text/x-script.phyton
pyc:applicaiton/x-bytecode.python
qcp:audio/vnd.qcelp
qd3:x-world/x-3dmf
#qd3d:x-world/x-3dmf
qif:image/x-quicktime
qt:video/quicktime
qtc:video/x-qtc
qti:image/x-quicktime
qtif:image/x-quicktime
ra:audio/x-pn-realaudio
#ra:audio/x-pn-realaudio-plugin
#ra:audio/x-realaudio
ram:audio/x-pn-realaudio
ras:application/x-cmu-raster
#ras:image/cmu-raster
#ras:image/x-cmu-raster
#rast:image/cmu-raster
#rexx:text/x-script.rexx
#rf:image/vnd.rn-realflash
rgb:image/x-rgb
rm:application/vnd.rn-realmedia
#rm:audio/x-pn-realaudio
rmi:audio/mid
rmm:audio/x-pn-realaudio
rmp:audio/x-pn-realaudio
#rmp:audio/x-pn-realaudio-plugin
rng:application/ringing-tones
#rng:application/vnd.nokia.ringing-tone
rnx:application/vnd.rn-realplayer
roff:application/x-troff
rp:image/vnd.rn-realpix
rpm:audio/x-pn-realaudio-plugin
rt:text/richtext
#rt:text/vnd.rn-realtext
rtf:application/rtf
#rtf:application/x-rtf
#rtf:text/richtext
#rtx:application/rtf
#rtx:text/richtext
rv:video/vnd.rn-realvideo
s:text/x-asm
s3m:audio/s3m
#saveme:application/octet-stream
sbk:application/x-tbook
scm:application/x-lotusscreencam
#scm:text/x-script.guile
#scm:text/x-script.scheme
#scm:video/x-scm
sdml:text/plain
sdp:application/sdp
#sdp:application/x-sdp
sdr:application/sounder
sea:application/sea
#sea:application/x-sea
set:application/set
sgm:text/sgml
#sgm:text/x-sgml
sgml:text/sgml
#sgml:text/x-sgml
sh:application/x-bsh
#sh:application/x-sh
#sh:application/x-shar
#sh:text/x-script.sh
shar:application/x-bsh
#shar:application/x-shar
shtml:text/html
#shtml:text/x-server-parsed-html
sid:audio/x-psid
#sit:application/x-sit
sit:application/x-stuffit
skd:application/x-koan
skm:application/x-koan
skp:application/x-koan
skt:application/x-koan
sl:application/x-seelogo
smi:application/smil
smil:application/smil
#snd:audio/basic
snd:audio/x-adpcm
sol:application/solids
#spc:application/x-pkcs7-certificates
spc:text/x-speech
spl:application/futuresplash
spr:application/x-sprite
sprite:application/x-sprite
src:application/x-wais-source
ssi:text/x-server-parsed-html
ssm:application/streamingmedia
sst:application/vnd.ms-pki.certstore
step:application/step
stl:application/sla
#stl:application/vnd.ms-pki.stl
#stl:application/x-navistyle
stp:application/step
sv4cpio:application/x-sv4cpio
sv4crc:application/x-sv4crc
svf:image/vnd.dwg
#svf:image/x-dwg
svr:application/x-world
#svr:x-world/x-svr
swf:application/x-shockwave-flash
t:application/x-troff
talk:text/x-speech
tar:application/x-tar
tbk:application/toolbook
#tbk:application/x-tbook
tcl:application/x-tcl
#tcl:text/x-script.tcl
tcsh:text/x-script.tcsh
tex:application/x-tex
texi:application/x-texinfo
texinfo:application/x-texinfo
#text:application/plain
text:text/plain
#tgz:application/gnutar
tgz:application/x-compressed
tif:image/tiff
#tif:image/x-tiff
tiff:image/tiff
#tiff:image/x-tiff
tr:application/x-troff
tsi:audio/tsp-audio
tsp:application/dsptype
#tsp:audio/tsplayer
tsv:text/tab-separated-values
turbot:image/florian
txt:text/plain
uil:text/x-uil
uni:text/uri-list
unis:text/uri-list
unv:application/i-deas
uri:text/uri-list
uris:text/uri-list
ustar:application/x-ustar
#ustar:multipart/x-ustar
uu:application/octet-stream
#uu:text/x-uuencode
uue:text/x-uuencode
vcd:application/x-cdlink
vcs:text/x-vcalendar
vda:application/vda
vdo:video/vdo
vew:application/groupwise
viv:video/vivo
#viv:video/vnd.vivo
vivo:video/vivo
#vivo:video/vnd.vivo
vmd:application/vocaltec-media-desc
vmf:application/vocaltec-media-file
voc:audio/voc
#voc:audio/x-voc
vos:video/vosaic
vox:audio/voxware
vqe:audio/x-twinvq-plugin
vqf:audio/x-twinvq
vql:audio/x-twinvq-plugin
vrml:application/x-vrml
#vrml:model/vrml
#vrml:x-world/x-vrml
vrt:x-world/x-vrt
vsd:application/x-visio
vst:application/x-visio
vsw:application/x-visio
w60:application/wordperfect6.0
w61:application/wordperfect6.1
w6w:application/msword
wav:audio/wav
#wav:audio/x-wav
wb1:application/x-qpro
wbmp:image/vnd.wap.wbmp
web:application/vnd.xara
wiz:application/msword
wk1:application/x-123
wmf:windows/metafile
wml:text/vnd.wap.wml
wmlc:application/vnd.wap.wmlc
wmls:text/vnd.wap.wmlscript
wmlsc:application/vnd.wap.wmlscriptc
word:application/msword
wp:application/wordperfect
wp5:application/wordperfect
#wp5:application/wordperfect6.0
wp6:application/wordperfect
wpd:application/wordperfect
#wpd:application/x-wpwin
wq1:application/x-lotus
wri:application/mswrite
#wri:application/x-wri
#wrl:application/x-world
wrl:model/vrml
#wrl:x-world/x-vrml
#wrz:model/vrml
#wrz:x-world/x-vrml
#wsc:text/scriplet
wsrc:application/x-wais-source
wtk:application/x-wintalk
#xbm:image/x-xbitmap
#xbm:image/x-xbm
xbm:image/xbm
xdr:video/x-amt-demorun
xgz:xgl/drawing
xif:image/vnd.xiff
xl:application/excel
xla:application/excel
#xla:application/x-excel
#xla:application/x-msexcel
#xlb:application/excel
#xlb:application/vnd.ms-excel
xlb:application/x-excel
#xlc:application/excel
#xlc:application/vnd.ms-excel
#xlc:application/x-excel
xld:application/excel
#xld:application/x-excel
#xlk:application/excel
xlk:application/x-excel
#xll:application/excel
#xll:application/vnd.ms-excel
xll:application/x-excel
#xlm:application/excel
#xlm:application/vnd.ms-excel
xlm:application/x-excel
#xls:application/excel
#xls:application/vnd.ms-excel
#xls:application/x-excel
xls:application/x-msexcel
#xlt:application/excel
xlt:application/x-excel
#xlv:application/excel
xlv:application/x-excel
#xlw:application/excel
#xlw:application/vnd.ms-excel
#xlw:application/x-excel
xlw:application/x-msexcel
xm:audio/xm
#xml:application/xml
xml:text/xml
xmz:xgl/movie
xpix:application/x-vnd.ls-xpix
#xpm:image/x-xpixmap
xpm:image/xpm
x-png:image/png
xsr:video/x-amt-showrun
#xwd:image/x-xwd
xwd:image/x-xwindowdump
xyz:chemical/x-pdb
#z:application/x-compress
z:application/x-compressed
#zip:application/x-compressed
#zip:application/x-zip-compressed
zip:application/zip
#zip:multipart/x-zip
zoo:application/octet-stream
zsh:text/x-script.zsh
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Examples</p></li>
</ol>
<ol class="loweralpha simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.csv</span></code> file</p></li>
</ol>
<p>save <code class="docutils literal notranslate"><span class="pre">csv</span></code> file in memory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">csv_io</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_io</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">csv_io</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c1"># the csv data need encode</span>
<span class="n">csv_data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">csv_io</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<blockquote>
<div><p>The alternative way by using <code class="docutils literal notranslate"><span class="pre">tempfile</span></code>:</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#</span>
<span class="n">s3_file_upload</span><span class="p">(</span><span class="n">csv_data</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Upload file</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;my_bucket/~~/~~/test/test.csv&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s3_file_upload</span><span class="p">(</span><span class="n">csv_data</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
<span class="go">test.csv has been successfully saved in S3!</span>
</pre></div>
</div>
<ol class="loweralpha simple" start="2">
<li><p><code class="docutils literal notranslate"><span class="pre">.json</span></code> file</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">json_object</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; your json content&quot;&quot;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_object</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;my_bucket/~~/~~/test/test.json&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s3_file_upload</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
<span class="go">test.json has been successfully saved in S3!</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<blockquote>
<div><p>The alternative way by using <code class="docutils literal notranslate"><span class="pre">tempfile</span></code>:</p>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#</span>
<span class="n">s3_file_upload</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<ol class="loweralpha simple" start="3">
<li><p><code class="docutils literal notranslate"><span class="pre">.png</span></code>, <code class="docutils literal notranslate"><span class="pre">.jpeg</span></code> or <code class="docutils literal notranslate"><span class="pre">.pdf</span></code></p></li>
</ol>
<p>Save the image in memory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">flights</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;flights&quot;</span><span class="p">)</span>
<span class="n">may_flights</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;month == &#39;May&#39;&quot;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">may_flights</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;passengers&quot;</span><span class="p">)</span>

<span class="n">img_data</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">img_data</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>
<span class="n">img_data</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Save the in-memory image data in S3:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;my_bucket/my_key&#39;</span>
<span class="n">s3_file_save</span><span class="p">(</span><span class="n">img_data</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The above method also works for <code class="docutils literal notranslate"><span class="pre">.jpeg</span></code> and <code class="docutils literal notranslate"><span class="pre">.pdf</span></code> format.</p>
</div>
</div>
<div class="section" id="file-download-from-s3">
<h3><span class="section-number">26.3.3. </span>File Download from S3<a class="headerlink" href="#file-download-from-s3" title="Permalink to this headline">¶</a></h3>
<p>The main idea is using the s3 resource function to download the file and save
it at <code class="docutils literal notranslate"><span class="pre">/temp</span></code> as a temporary file, the use the corresponding formatted
functions to read it.</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">s3_file_download</span></code> Function</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">s3_file_download</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="c1"># extract bucket and key from the given path</span>
    <span class="n">s3_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;s3://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;s3a://&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">s3_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># download file and save it as a temp file</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/tmp&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">s3_resource</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="c1"># return saved file path</span>
    <span class="k">return</span> <span class="n">file_name</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Examples</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;my_bucket/***/***/test/test.json&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">file_name</span> <span class="o">=</span> <span class="n">s3_file_download</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="go">&#39;/temp/test.json&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="file-management-in-s3">
<h3><span class="section-number">26.3.4. </span>File Management in S3<a class="headerlink" href="#file-management-in-s3" title="Permalink to this headline">¶</a></h3>
<p>I mainly use my <code class="docutils literal notranslate"><span class="pre">s3_fs</span></code> to help me do the file management in S3.</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">s3_fs</span></code> Function</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">s3_fs</span></code> is mainly based on <code class="docutils literal notranslate"><span class="pre">s3fs</span></code> package. The top-level class
<code class="docutils literal notranslate"><span class="pre">s3fs</span></code> holds connection information and allows typical file-system style
operations like <code class="docutils literal notranslate"><span class="pre">cp</span></code>, <code class="docutils literal notranslate"><span class="pre">mv</span></code>, <code class="docutils literal notranslate"><span class="pre">ls</span></code>, <code class="docutils literal notranslate"><span class="pre">walk</span></code>, <code class="docutils literal notranslate"><span class="pre">du</span></code>, <code class="docutils literal notranslate"><span class="pre">glob</span></code>, etc.
More details can be found at:
<a class="reference external" href="https://s3fs.readthedocs.io/en/latest/index.html">https://s3fs.readthedocs.io/en/latest/index.html</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">s3fs</span>

<span class="n">s3_fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">key</span><span class="o">=</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;AccessKeyId&#39;</span><span class="p">],</span>
                          <span class="n">secret</span><span class="o">=</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;SecretAccessKey&#39;</span><span class="p">],</span>
                          <span class="n">token</span><span class="o">=</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;SessionToken&#39;</span><span class="p">])</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Examples</p></li>
</ol>
<p>Simple locate and read a file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s3_fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="s1">&#39;my-bucket&#39;</span><span class="p">)</span>
<span class="go">[&#39;demo-file.csv&#39;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;my-bucket/demo-file.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="go">b&#39;UserId\tdate\nuser_id1\t2019-05-02\nuser_id2\t2019-12-02\n&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="delta-format">
<h2><span class="section-number">26.4. </span><code class="docutils literal notranslate"><span class="pre">delta</span></code> format<a class="headerlink" href="#delta-format" title="Permalink to this headline">¶</a></h2>
<p>TODO…</p>
</div>
<div class="section" id="mlflow">
<h2><span class="section-number">26.5. </span><code class="docutils literal notranslate"><span class="pre">mlflow</span></code><a class="headerlink" href="#mlflow" title="Permalink to this headline">¶</a></h2>
<p>TODO…</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="api.html" class="btn btn-neutral float-right" title="27. PySpark API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="jdbc.html" class="btn btn-neutral float-left" title="25. JDBC Connection" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Wenqiang Feng
      <span class="lastupdated">
        Last updated on Dec 27, 2021.
      </span>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>